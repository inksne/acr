name: ACR Publish

on:
  workflow_run:
    workflows: ["ACR CI"]
    types:
      - completed

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (fetch tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set HEAD_SHA env from triggering workflow
        run: echo "HEAD_SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV

      - name: Check for tag pointing at HEAD_SHA
        id: check_tag
        run: |
          echo "Looking for tags that point to $HEAD_SHA"
          TAGS=$(git tag --points-at "$HEAD_SHA" || true)
          echo "Found tags: '$TAGS'"
          if [ -z "$TAGS" ]; then
            echo "no_tag=true" >> $GITHUB_OUTPUT
          else
            FIRST_TAG=$(printf '%s\n' "$TAGS" | head -n1)
            echo "no_tag=false" >> $GITHUB_OUTPUT
            echo "release_tag=$FIRST_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Skip publish if no tag on the commit
        if: ${{ steps.check_tag.outputs.no_tag == 'true' }}
        run: |
          echo "No tag pointing at commit $HEAD_SHA â€” skipping publish."
          # exit 0 to finish job normally (not fail)
          exit 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip build twine

      - name: Install deps (for build)
        run: |
          poetry install --no-interaction --no-ansi

      - name: Build distributions
        run: |
          poetry build
        env:
          POETRY_CACHE_DIR: ${{ runner.temp }}/poetry-cache

      - name: Publish to PyPI (conditional)
        # Will only be executed if ENABLE_PUBLISH = "true" is set in Settings -> Secrets -> Actions
        if: ${{ secrets.ENABLE_PUBLISH == 'true' }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "Publishing to PyPI..."
          python -m twine upload dist/* --non-interactive

      - name: Publish skipped message
        if: ${{ secrets.ENABLE_PUBLISH != 'true' }}
        run: |
          echo "Publishing to PyPI skipped because secret ENABLE_PUBLISH != 'true'."
          echo "Set repository secret ENABLE_PUBLISH to 'true' to enable real publish."

      - name: Create GitHub Release (conditional)
        if: ${{ secrets.ENABLE_PUBLISH == 'true' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.check_tag.outputs.release_tag }}
          name: ${{ steps.check_tag.outputs.release_tag }}
          body: |
            Release ${{ steps.check_tag.outputs.release_tag }}
          artifacts: dist/*
          draft: false
          prerelease: false

      - name: Create local release artifact (for testing)
        if: ${{ secrets.ENABLE_PUBLISH != 'true' }}
        run: |
          echo "Skipping creating GitHub Release (ENABLE_PUBLISH != 'true')."
          echo "You can still download dist/ from CI artifacts to inspect built packages."